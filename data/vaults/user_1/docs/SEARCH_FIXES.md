# Исправления Глобального и Локального Поиска

## Обзор изменений

Полностью исправлен и улучшен функционал поиска в приложении. Реализована подсветка вхождений при глобальном и локальном поиске, добавлена навигация по найденным совпадениям.

---

## 🔧 Исправленные проблемы

### 1. Backend Search API
**Файл:** `backend/app/search/api.py`

**Проблема:** Модель `Snippet` требовала обязательные поля `line` и `ranges`, которые не передавались при создании объектов.

**Решение:**
- Исправлена генерация snippets с корректным заполнением всех обязательных полей
- Добавлена логика определения номера строки для каждого snippet
- Реализовано извлечение позиций совпадений (ranges) для подсветки
- Добавлен fallback для случаев, когда highlights недоступны

**Изменения:**
```python
# Теперь snippet создается с полными данными:
Snippet(
    line=line_num,        # Номер строки (1-indexed)
    text=highlight_text,  # Текст snippet
    ranges=ranges         # Массив [start, end] позиций совпадений
)
```

---

### 2. CodeMirror Extension для Поиска
**Новый файл:** `frontend/src/lib/codemirror/search-highlight.ts`

**Функционал:**
- ✅ Поиск и подсветка всех вхождений в документе
- ✅ Выделение текущего активного совпадения (оранжевый цвет)
- ✅ Навигация по совпадениям (вперед/назад)
- ✅ Автоматический скролл к найденным элементам
- ✅ Case-insensitive поиск

**API:**
```typescript
interface SearchAPI {
  setQuery(query: string): void;     // Установить поисковый запрос
  nextMatch(): void;                  // Следующее совпадение
  prevMatch(): void;                  // Предыдущее совпадение
  clearSearch(): void;                // Очистить поиск
  getState(): SearchState;            // Получить состояние
}
```

**Стилизация:**
- `.cm-search-match` - жёлтая подсветка (#ffd54f) для всех совпадений
- `.cm-search-match-current` - оранжевая подсветка (#ff9800) для активного совпадения

---

### 3. Интеграция с Markdown Editor
**Файл:** `frontend/src/components/markdown-editor.tsx`

**Добавлено:**
- Интеграция расширения `searchHighlight()`
- Проп `searchQuery` для передачи поискового запроса извне
- Проп `onSearchStateChange` для уведомления о состоянии поиска
- Автоматическое применение поискового запроса при открытии файла
- Обработчик F3/Shift+F3 для навигации по совпадениям

**Новые пропсы:**
```typescript
interface EditorProps {
  // ... существующие пропсы
  searchQuery?: string;
  onSearchStateChange?: (state: {
    query: string;
    matchCount: number;
    currentMatch: number;
  }) => void;
}
```

---

### 4. Локальный Поиск (Ctrl+F)
**Файл:** `frontend/src/pages/Vault.tsx`

**Реализовано:**
- ✅ Полнофункциональный локальный поиск с подсветкой
- ✅ Панель управления с кнопками навигации
- ✅ Отображение счётчика совпадений (N of M)
- ✅ Keyboard shortcuts: F3 (следующее), Shift+F3 (предыдущее)
- ✅ Закрытие по Escape

**UI элементы:**
```
┌─────────────────────────────────────┐
│ Find in file                    [×] │
│ ┌─────────────────────────────────┐ │
│ │ Search in current file...       │ │
│ └─────────────────────────────────┘ │
│ 3 of 15                      [↑][↓] │
│ Use F3/Shift+F3 to navigate         │
└─────────────────────────────────────┘
```

---

### 5. Глобальный Поиск с Подсветкой
**Файлы:** 
- `frontend/src/components/Search.tsx`
- `frontend/src/pages/Vault.tsx`

**Реализовано:**
- ✅ При клике на результат глобального поиска файл открывается с подсвеченными вхождениями
- ✅ Автоматическая экстракция поисковых терминов из запроса
- ✅ Передача query от Search компонента к Editor
- ✅ Фильтрация операторов поиска (tag:, path:, [prop:]) для чистой подсветки

**Workflow:**
1. Пользователь выполняет глобальный поиск (Ctrl+Shift+F)
2. Кликает на результат
3. Файл открывается с подсвеченными совпадениями
4. Можно навигировать по совпадениям (F3/Shift+F3)

---

### 6. Панель Навигации в Status Bar
**Файл:** `frontend/src/pages/Vault.tsx`

**Добавлено:**
В нижнюю панель статуса добавлен индикатор поиска:
```
[💾 Saved] • 245 words • 1,432 characters • 0 backlinks • [3/15 matches]
```

Отображается только когда есть активные совпадения.

---

## 🎯 Использование

### Локальный поиск в файле (Ctrl+F)
1. Открыть файл
2. Нажать `Ctrl+F` (или `Cmd+F` на Mac)
3. Ввести поисковый запрос
4. Навигация:
   - `F3` - следующее совпадение
   - `Shift+F3` - предыдущее совпадение
   - `Esc` - закрыть поиск

### Глобальный поиск с подсветкой (Ctrl+Shift+F)
1. Нажать `Ctrl+Shift+F` (или `Cmd+Shift+F` на Mac)
2. Ввести запрос (например: `machine learning`)
3. Кликнуть на результат
4. Файл откроется с подсвеченными вхождениями
5. Навигация: `F3`/`Shift+F3`

### Продвинутый поиск
Глобальный поиск поддерживает операторы:
- `tag:work` - поиск по тегам
- `path:notes/` - поиск по пути
- `[status:todo]` - поиск по свойствам
- `"exact phrase"` - точная фраза
- Комбинации: `tag:work machine learning`

При клике на результат, операторы автоматически отфильтровываются, и в файле подсвечиваются только реальные текстовые совпадения.

---

## 🎨 Визуальные улучшения

### Подсветка в редакторе
- **Обычные совпадения:** Жёлтый фон (#ffd54f)
- **Текущее совпадение:** Оранжевый фон (#ff9800), жирный шрифт

### Панель локального поиска
- Минималистичный дизайн
- Кнопки навигации со стрелками
- Счётчик совпадений
- Подсказки по горячим клавишам

### Status bar
- Синий текст для счётчика совпадений
- Появляется только при активном поиске
- Не перегружает интерфейс

---

## 🔍 Технические детали

### Архитектура поиска
```
┌─────────────────────────────────────────┐
│         Frontend (React)                │
├─────────────────────────────────────────┤
│  Search Component                       │
│    ↓ (query + terms)                    │
│  Vault Page                             │
│    ↓ (searchQuery prop)                 │
│  Markdown Editor                        │
│    ↓ (via searchHighlight extension)   │
│  CodeMirror 6                           │
│    - SearchCursor для поиска            │
│    - Decorations для подсветки          │
│    - State management для навигации     │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│         Backend (FastAPI)               │
├─────────────────────────────────────────┤
│  /search endpoint                       │
│    ↓                                    │
│  Whoosh full-text search                │
│    - Highlights extraction              │
│    - Line number detection              │
│    - Range calculation                  │
│    ↓                                    │
│  SearchResponse с Snippets              │
└─────────────────────────────────────────┘
```

### Оптимизации
- **Debounce:** Локальный поиск с задержкой 300ms
- **Case-insensitive:** По умолчанию регистронезависимый поиск
- **Lazy loading:** Подсветка применяется только при наличии query
- **Efficient navigation:** O(1) переход между совпадениями

---

## 📝 Изменённые файлы

### Backend
- ✅ `backend/app/search/api.py` - исправлены Snippet модели

### Frontend
- ✅ `frontend/src/lib/codemirror/search-highlight.ts` - новый файл
- ✅ `frontend/src/lib/codemirror/types.ts` - добавлены пропсы
- ✅ `frontend/src/components/markdown-editor.tsx` - интеграция поиска
- ✅ `frontend/src/components/Search.tsx` - передача query
- ✅ `frontend/src/pages/Vault.tsx` - UI и состояние поиска

---

## ✅ Тестирование

### Проверьте следующие сценарии:

1. **Локальный поиск:**
   - [ ] Ctrl+F открывает панель поиска
   - [ ] Ввод текста подсвечивает совпадения
   - [ ] F3 переходит к следующему совпадению
   - [ ] Shift+F3 переходит к предыдущему
   - [ ] Esc закрывает панель
   - [ ] Счётчик показывает правильное количество

2. **Глобальный поиск:**
   - [ ] Ctrl+Shift+F открывает sidebar поиска
   - [ ] Поиск находит файлы
   - [ ] Клик на результат открывает файл
   - [ ] Совпадения подсвечены в открытом файле
   - [ ] Навигация работает

3. **Backend:**
   - [ ] Search API возвращает snippets с line и ranges
   - [ ] Highlights извлекаются корректно
   - [ ] Нет ошибок в логах

---

## 🚀 Дальнейшие улучшения (опционально)

- [ ] Regex поиск в локальном поиске
- [ ] Replace функционал
- [ ] Поиск с учётом регистра (toggle)
- [ ] Подсветка различными цветами для разных терминов
- [ ] История поисковых запросов в локальном поиске
- [ ] Fuzzy search
- [ ] Поиск по выделенному тексту

---

## 🎉 Результат

Поиск теперь работает полноценно:
- ✅ Глобальный поиск находит файлы
- ✅ При открытии файла из поиска подсвечиваются вхождения
- ✅ Локальный поиск (Ctrl+F) работает с подсветкой
- ✅ Навигация по вхождениям (F3/Shift+F3)
- ✅ Панель управления поиском
- ✅ Счётчик совпадений в status bar
- ✅ Backend корректно возвращает данные

Все TODO завершены! 🎊

