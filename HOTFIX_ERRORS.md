# Hotfix - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫

**–î–∞—Ç–∞:** 26 –æ–∫—Ç—è–±—Ä—è 2025  
**–ü—Ä–æ–±–ª–µ–º—ã:** IndexedDB ConstraintError + CORS –æ—à–∏–±–∫–∞

---

## üî¥ –ü–†–û–ë–õ–ï–ú–ê 1: IndexedDB ConstraintError

### –û—à–∏–±–∫–∞:
```
BulkError: linkIndex.bulkAdd(): 12 of 36 operations failed
ConstraintError: A mutation operation in the transaction failed 
because a constraint was not satisfied.
```

### –ü—Ä–∏—á–∏–Ω–∞:
–§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Å—ã–ª–æ–∫ –Ω–∞ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª:
```markdown
[[Welcome]] —Ç–µ–∫—Å—Ç [[Welcome]] –µ—â–µ —Ç–µ–∫—Å—Ç [[Welcome]]
```

–ü—Ä–∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è 3 –∑–∞–ø–∏—Å–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º ID:
- `Welcome.md+notes/Welcome.md`
- `Welcome.md+notes/Welcome.md` ‚ùå –¥—É–±–ª–∏–∫–∞—Ç!
- `Welcome.md+notes/Welcome.md` ‚ùå –¥—É–±–ª–∏–∫–∞—Ç!

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
‚úÖ **–§–∞–π–ª:** `frontend/src/search/idb.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Å—Å—ã–ª–æ–∫ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º
2. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Ç–µ–≥–æ–≤ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)

**–ö–æ–¥:**
```typescript
// –ë—ã–ª–æ:
await this.linkIndex.bulkAdd(
  meta.links.map(link => ({...}))
);

// –°—Ç–∞–ª–æ:
const linkMap = new Map<string, {...}>();
for (const link of meta.links) {
  const id = `${link.target}+${file.path}`;
  if (!linkMap.has(id)) {
    linkMap.set(id, {...});
  }
}
const uniqueLinks = Array.from(linkMap.values());
await this.linkIndex.bulkAdd(uniqueLinks);
```

---

## üî¥ –ü–†–û–ë–õ–ï–ú–ê 2: CORS –æ—à–∏–±–∫–∞

### –û—à–∏–±–∫–∞:
```
–ó–∞–ø—Ä–æ—Å –∏–∑ –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: 
–ü–æ–ª–∏—Ç–∏–∫–∞ –æ–¥–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∑–∞–ø—Ä–µ—â–∞–µ—Ç —á—Ç–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞ 
–Ω–∞ http://localhost:8000/api/search
```

### –ü—Ä–∏—á–∏–Ω–∞:
1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ middleware** - CORS –±—ã–ª –Ω–µ –ø–µ—Ä–≤—ã–º
2. **SecurityHeadersMiddleware –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª OPTIONS** - preflight –∑–∞–ø—Ä–æ—Å—ã

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
‚úÖ **–§–∞–π–ª:** `backend/app/main.py`

**–ë—ã–ª–æ:**
```python
app.add_middleware(SecurityHeadersMiddleware)
app.add_middleware(ErrorHandlingMiddleware)
app.add_middleware(LoggingMiddleware)

# CORS middleware
app.add_middleware(CORSMiddleware, ...)
```

**–°—Ç–∞–ª–æ:**
```python
# CORS middleware - MUST be first!
app.add_middleware(CORSMiddleware, ...)

# Other middlewares
app.add_middleware(SecurityHeadersMiddleware)
app.add_middleware(ErrorHandlingMiddleware)
app.add_middleware(LoggingMiddleware)
```

‚úÖ **–§–∞–π–ª:** `backend/app/middleware.py`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```python
async def dispatch(self, request: Request, call_next):
    # Skip security headers for OPTIONS (CORS preflight)
    if request.method == "OPTIONS":
        return await call_next(request)
    
    # ... rest of code
```

---

## ‚úÖ –ö–ê–ö –ü–†–ò–ú–ï–ù–ò–¢–¨

### 1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend:
```bash
cd backend

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å (Ctrl+C)
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–Ω–æ–≤–∞
python -m app.main
```

### 2. –û—á–∏—Å—Ç–∏—Ç—å IndexedDB –≤ –±—Ä–∞—É–∑–µ—Ä–µ:
```javascript
// –û—Ç–∫—Ä—ã—Ç—å DevTools Console
// –í—ã–ø–æ–ª–Ω–∏—Ç—å:
indexedDB.deleteDatabase('ObsidianSearchDB');

// –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5)
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
```bash
# 1. –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª Welcome.md
# 2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å (Ctrl+S)
# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å - –æ—à–∏–±–æ–∫ –±—ã—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–æ
# 4. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –¢–µ—Å—Ç 1: IndexedDB
```bash
1. –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª —Å–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏
2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å: ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ ConstraintError
```

### –¢–µ—Å—Ç 2: CORS
```bash
1. –û—Ç–∫—Ä—ã—Ç—å –ø–æ–∏—Å–∫
2. –í–≤–µ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å: "test"
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Network tab: ‚úÖ –ó–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω (200)
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å: ‚úÖ –ù–µ—Ç CORS –æ—à–∏–±–æ–∫
```

### –¢–µ—Å—Ç 3: –§–µ–¥–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫
```bash
1. –ü–æ–∏—Å–∫: tag:work "important"
2. –î–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π + —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
3. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è
```

---

## üìä –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### –ü–æ—á–µ–º—É CORS middleware –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–≤—ã–º?

FastAPI –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç middleware –≤ **–æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ** –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:

```
Request ‚Üí [Last Middleware] ‚Üí ... ‚Üí [First Middleware] ‚Üí Handler
         ‚Üì
Response ‚Üê [First Middleware] ‚Üê ... ‚Üê [Last Middleware] ‚Üê Handler
```

–ï—Å–ª–∏ CORS –Ω–µ –ø–µ—Ä–≤—ã–π:
1. OPTIONS –∑–∞–ø—Ä–æ—Å –ø—Ä–∏—Ö–æ–¥–∏—Ç
2. SecurityHeadersMiddleware –ø—ã—Ç–∞–µ—Ç—Å—è –µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
3. CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è
4. –ë—Ä–∞—É–∑–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å ‚ùå

–ï—Å–ª–∏ CORS –ø–µ—Ä–≤—ã–π:
1. OPTIONS –∑–∞–ø—Ä–æ—Å –ø—Ä–∏—Ö–æ–¥–∏—Ç
2. CORSMiddleware —Å—Ä–∞–∑—É –¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏
3. –ë—Ä–∞—É–∑–µ—Ä —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –∑–∞–ø—Ä–æ—Å ‚úÖ

### –ü–æ—á–µ–º—É Map –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏?

Set –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤:
```typescript
// ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
const set = new Set([
  {id: "1", ...},
  {id: "1", ...}  // –†–∞–∑–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã!
]);
set.size; // 2 (–Ω–µ –¥–µ–¥—É–ø–ª–∏—Ü–∏—Ä–æ–≤–∞–ª–æ—Å—å)

// ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç
const map = new Map();
map.set("1", {...});
map.set("1", {...});  // –ü–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç!
map.size; // 1
```

---

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –î–æ:
- ‚ùå –û—à–∏–±–∫–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤ —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏ —Å—Å—ã–ª–æ–∫
- ‚ùå CORS –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–∏—Å–∫
- ‚ùå –§–µ–¥–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∫—Ä–∞—Å–Ω—ã–µ –æ—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏

### –ü–æ—Å–ª–µ:
- ‚úÖ –§–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ö–æ–Ω—Å–æ–ª—å —á–∏—Å—Ç–∞—è

---

## üìù –ß–ï–ö–õ–ò–°–¢

- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `idb.ts` (–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è)
- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `main.py` (–ø–æ—Ä—è–¥–æ–∫ middleware)
- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `middleware.py` (OPTIONS bypass)
- [x] Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
- [ ] IndexedDB –æ—á–∏—â–µ–Ω (—Ä—É–∫–∞–º–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
- [ ] –¢–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
**–¢—Ä–µ–±—É–µ—Ç—Å—è:** –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ backend + –æ—á–∏—Å—Ç–∫–∞ IndexedDB

